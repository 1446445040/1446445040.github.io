# 客户端

## 依赖版本有误引起的莫名其妙的错误

`ant-design-vue^1.5.4`依赖`moment^2.21.0`，而项目中又自行安装了最新版`moment^2.25.1`。导致组件库的内部引用关系错乱。

**排查手段**：安装moment之后出现错误，通过报错信息排查组件库内发生错误的文件，发现内部引用方式和地址均有误。但之前使用正常，且在按理说组件库一般不会出现这种低级错误，**尝试手动修正引用位置后发现项目运行正常**，猜测应该是`moment`版本不一致所致。核对后发现果真如此，重新安装`moment^2.21.0`后解决问题。

# 服务端

## MongoDB

- 事务操作：需要搭建集群，开启多个MongoDB实例并添加副本集
- DAO类封装：目的在于——成功时返回数据，错误则统一处理。
- 事务的封装：借鉴了`Promise`的实现原理，将`session`对象传入`executor`。**其目的是复用已封装的增删改查函数**。

```javascript
/**
 * 事务函数
 */
async function transaction(executor) {
    return new Promise((resolve, reject) => {
        // 初始化连接，获取session
        ···
        const results = await excutor(session)
        ···
        // 根据结果成功与否做提交或回滚
    })
}

// 外部引用
transaction(session => Promise.all([
    insert(USER, data, { session }),
    insert(STUDENT, data, { session })
])).then(results => {
    ···
}).catch(e => {
    ···
})
```



## 副本集搭建

更改配置文件，开启三个`MongoDB`实例，一个主节点，一个从节点，一个仲裁节点。`Mongo Shell`登录主节点，使用`rs.add()`添加从节点，使用`rs.addArb()`添加仲裁节点。

仲裁节点不保存数据，仅在主节点宕机后参与投票选举新的主节点。**当节点数为偶数时需要部署仲裁节点**，否则主节点宕机后，从节点不会主动升级为主节点，导致数据库读写异常。

若开启**认证鉴权**，则需要配置`keyFile`，同一个副本集的节点需要使用同一份`key`

## 表结构设计

数据表共分为账号表，学生表，管理员表，教师表，这些表中有一部分字段是通用的，例如`account`、`password`、`name`。起初设计时将这三个字段区分开`sid, tid, sname, tname`。随后的编码过程中发现前后端字段不一致，需要不停转换，而且前后端都要做，极为不便。**最后决定将这些字段替换为上述的通用字段**，使用一个额外的`type`字段来标识身份，简化了很多逻辑。